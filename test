// ==UserScript==
// @name         Amazon Spec Filter (Weight + Dimensions)
// @namespace    https://chatgpt.com/
// @version      1.0
// @description  Filter Amazon products by weight or dimensions using only visible on-page data (safe + TOS-compliant)
// @match        https://www.amazon.*/*
// @grant        none
// ==/UserScript==

(function () {
    "use strict";

    /*******************************
     UI PANEL
    ********************************/
    const panel = document.createElement("div");
    panel.style.position = "fixed";
    panel.style.top = "20px";
    panel.style.right = "20px";
    panel.style.zIndex = "999999";
    panel.style.background = "white";
    panel.style.padding = "12px";
    panel.style.border = "2px solid #444";
    panel.style.borderRadius = "6px";
    panel.style.fontSize = "14px";
    panel.style.width = "200px";
    panel.style.boxShadow = "0 0 10px rgba(0,0,0,0.3)";
    panel.innerHTML = `
        <b>Amazon Spec Filter</b><br><br>
        <label>Max Weight (lb):</label><br>
        <input id="asf-weight" type="number" min="0" step="0.1" style="width:100%;"><br><br>

        <label>Max Length (in):</label><br>
        <input id="asf-len" type="number" min="0" step="0.1" style="width:100%;"><br>
        <label>Max Width (in):</label><br>
        <input id="asf-wid" type="number" min="0" step="0.1" style="width:100%;"><br>
        <label>Max Height (in):</label><br>
        <input id="asf-hei" type="number" min="0" step="0.1" style="width:100%;"><br><br>

        <button id="asf-run" style="width:100%; padding:6px;">Filter</button>
        <button id="asf-clear" style="width:100%; padding:6px; margin-top:6px;">Reset</button>
    `;
    document.body.appendChild(panel);

    /*******************************
     HELPERS
    ********************************/
    function extractNumber(str) {
        const match = str.replace(",", "").match(/([\d.]+)/);
        return match ? parseFloat(match[1]) : null;
    }

    function inchesFromText(str) {
        if (!str) return null;
        const num = extractNumber(str);
        return str.toLowerCase().includes("cm") ? (num / 2.54) : num;
    }

    function poundsFromText(str) {
        if (!str) return null;
        const num = extractNumber(str);
        return str.toLowerCase().includes("kg") ? (num * 2.20462) : num;
    }

    /*******************************
     PARSE PRODUCT SPECS FROM NODE
    ********************************/
    function parseSpecsFromNode(node) {
        const text = node.innerText.toLowerCase();

        // Weight
        let weight = null;
        const wMatch = text.match(/(\d[\d.,]*)\s*(pounds?|lbs?|kg)/);
        if (wMatch) weight = poundsFromText(wMatch[0]);

        // Dimensions
        let L = null, W = null, H = null;
        const dimMatch = text.match(/(\d[\d.,]*\s*(inches|inch|in|cm))\s*[x×]\s*(\d[\d.,]*\s*(inches|inch|in|cm))\s*[x×]\s*(\d[\d.,]*\s*(inches|inch|in|cm))/);

        if (dimMatch) {
            const parts = dimMatch[0].split(/[x×]/i);
            if (parts.length === 3) {
                L = inchesFromText(parts[0]);
                W = inchesFromText(parts[1]);
                H = inchesFromText(parts[2]);
            }
        }

        return { weight, L, W, H };
    }

    /*******************************
     MAIN FILTER FUNCTION
    ********************************/
    function runFilter() {
        const maxWeight = parseFloat(document.getElementById("asf-weight").value) || Infinity;
        const maxL = parseFloat(document.getElementById("asf-len").value) || Infinity;
        const maxW = parseFloat(document.getElementById("asf-wid").value) || Infinity;
        const maxH = parseFloat(document.getElementById("asf-hei").value) || Infinity;

        // Search result items
        const items = [
            ...document.querySelectorAll("[data-component-type='s-search-result']"),
            ...document.querySelectorAll("#dp-container, #ppd")
        ];

        items.forEach(item => {
            const specs = parseSpecsFromNode(item);

            const fail =
                (specs.weight && specs.weight > maxWeight) ||
                (specs.L && specs.L > maxL) ||
                (specs.W && specs.W > maxW) ||
                (specs.H && specs.H > maxH);

            item.style.opacity = fail ? "0.25" : "1";
            item.style.display = fail ? "none" : "";
        });
    }

    /*******************************
     EVENTS
    ********************************/
    document.getElementById("asf-run").onclick = runFilter;

    document.getElementById("asf-clear").onclick = () => {
        document.getElementById("asf-weight").value = "";
        document.getElementById("asf-len").value = "";
        document.getElementById("asf-wid").value = "";
        document.getElementById("asf-hei").value = "";

        [...document.querySelectorAll("[data-component-type='s-search-result'], #dp-container, #ppd")].forEach(item => {
            item.style.opacity = "1";
            item.style.display = "";
        });
    };

})();
